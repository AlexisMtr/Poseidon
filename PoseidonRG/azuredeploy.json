{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "env": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "qa",
        "prod"
      ]
    },
    "web-api-name": {
      "type": "string",
      "defaultValue": "poseidon-api"
    },
    "web-api-service-plan-name": {
      "type": "string",
      "defaultValue": "poseidon-appservice-plan"
    },
    "device-endpoint-name": {
      "type": "string",
      "defaultValue": "poseidon-device"
    },
    "device-endpoint-service-plan-name": {
      "type": "string",
      "defaultValue": "poseidon-device-service-plan"
    },
    "device-battery-alarm-level": {
      "type": "int",
      "defaultValue": 20,
      "minValue": 0,
      "maxValue": 100,
      "metadata": {
        "description": "Minimum pourcentage of battery before send alarms"
      }
    },
    "storage-account-name": {
      "type": "string",
      "defaultValue": "poseidonstorageaccount"
    },
    "storage-acccount-type": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [ "Standard_LRS", "Standard_GRS", "Standard_RAGRS" ],
      "metadata": {
        "description": "Storage Account type"
      }
    },
    "database-server-name": {
      "type": "string",
      "defaultValue": "poseidon-sql-srv"
    },
    "database-name": {
      "type": "string",
      "defaultValue": "poseidon-sql-db"
    },
    "database-user": {
      "type": "string",
      "defaultValue": "poseidon-admin"
    },
    "database-pwd": {
      "type": "securestring"
    },
    "database-enable-mars": {
      "type": "bool",
      "defaultValue": false,
      "allowedValues": [ true, false ]
    },
    "signing-key": {
      "type": "string"
    }
  },
  "variables": {
    "database-server-resource-name": "[concat(parameters('env'), '-', parameters('database-server-name'))]",
    "database-resource-name": "[concat(parameters('env'), '-', parameters('database-name'))]",
    "storage-account-resource-name": "[concat(parameters('env'), parameters('storage-account-name'))]",
    "device-service-resource-name": "[concat(parameters('env'), '-', parameters('device-endpoint-name'))]",
    "device-service-plan-resource-name": "[concat(parameters('env'), '-', parameters('device-endpoint-service-plan-name'))]",
    "web-api-resource-name": "[concat(parameters('env'), '-', parameters('web-api-name'))]",
    "web-api-service-plan-resource-name": "[concat(parameters('env'), '-', parameters('web-api-service-plan-name'))]",
    "sql-connection-string": "[concat('Server=tcp:', parameters('database-server-name'), '.database.windows.net,1443;Initial Catalog=', parameters('database-name'), ';Persist Security Info=False;User ID=', parameters('database-user'), ';Password=', parameters('database-pwd'), ';MultipleActiveResultSets=', parameters('database-enable-mars'), ';Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]",
    "storageaccount-connection-string": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storage-account-name'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storage-account-name')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]"
  },
  "resources": [
    {
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "name": "[variables('web-api-service-plan-resource-name')]",
      "properties": {
        "sku": "Free"
      },
      "type": "Microsoft.Web/serverfarms"
    },
    {
      "comments": "Consumption service plan",
      "name": "[variables('device-service-plan-resource-name')]",
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2016-09-01",
      "properties": {
        "computeMode": "Dynamic",
        "sku": "Dynamic"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storage-account-resource-name')]",
      "apiVersion": "2018-02-01",
      "location": "[resourceGroup().location]",
      "kind": "Storage",
      "sku": {
        "name": "[parameters('storage-acccount-type')]"
      }
    },
    {
      "apiVersion": "2014-04-01",
      "location": "[resourceGroup().location]",
      "name": "[variables('database-server-resource-name')]",
      "properties": {
        "administratorLogin": "[parameters('database-user')]",
        "administratorLoginPassword": "[parameters('database-pwd')]",
        "version": "12.0"
      },
      "resources": [
        {
          "apiVersion": "2014-04-01",
          "location": "[resourceGroup().location]",
          "name": "[variables('database-resource-name')]",
          "properties": {
            "edition": "Free"
          },
          "type": "databases",
          "dependsOn": [
            "[resourceId('Microsoft.Sql/servers', variables('database-server-resource-name'))]"
          ]
        }
      ],
      "type": "Microsoft.Sql/servers"
    },
    {
      "apiVersion": "2016-08-01",
      "location": "[resourceGroup().location]",
      "name": "[variables('web-api-resource-name')]",
      "type": "Microsoft.Web/sites",
      "properties": {
        "appSettings": [
          {
            "name": "IssuerSigningKey:SigningKey",
            "value": "[parameters('signing-key')]"
          }
        ],
        "connectionStrings": [
          {
            "name": "DefaultConnection",
            "type": "SQLAzure",
            "connectionString": "[variables('sql-connection-string')]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('database-server-resource-name'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('web-api-service-plan-resource-name'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites",
      "location": "[resourceGroup().location]",
      "name": "[variables('device-service-resource-name')]",
      "kind": "functionapp",
      "apiVersion": "2018-11-01",
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('database-server-resource-name'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('device-service-plan-resource-name'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storage-account-resource-name'))]"
      ],
      "properties": {
        "appSettings": [
          {
            "name": "BatteryLevelAlarm",
            "value": "[parameters('device-battery-alarm-level')]"
          },
          {
            "name": "FUNCTIONS_WORKER_RUNTIME",
            "value": "dotnet"
          },
          {
            "name": "AzureWebJobsStorage",
            "value": "[variables('storageaccount-connection-string')]"
          },
          {
            "name": "AzureWebJobsDashboard",
            "value": "[variables('storageaccount-connection-string')]"
          }
        ],
        "connectionStrings": [
          {
            "name": "DefaultConnection",
            "type": "SQLAzure",
            "connectionString": "[variables('sql-connection-string')]"
          }
        ]
      }
    }
  ]
}